# 新系统设计文档

## 核心设计理念

### 1. 使用次数系统（而非激活状态）
- 用户有"使用次数"（credits）
- 前3次免费试用
- 激活码充值：+100次
- 邀请码奖励：双方各+3次

### 2. 双重存储策略
**客户端（localStorage）**：
- 存储剩余次数（快速显示）
- 存储已使用的免费试用次数

**服务端（D1数据库）**：
- 记录真实使用记录（防篡改）
- 验证每次使用的合法性
- 同步客户端数据

### 3. 使用流程

```
用户使用服务
  ↓
检查 localStorage 中的剩余次数
  ↓
如果有剩余次数 → 调用 API
  ↓
API 验证服务端记录
  ↓
如果验证通过 → 扣除次数（客户端+服务端）
  ↓
返回结果
```

## 数据结构

### 客户端存储（localStorage）
```typescript
{
  "remaining_credits": 97,  // 剩余次数
  "free_trials_used": 3,    // 已使用的免费试用次数
  "last_synced": 1234567890 // 最后同步时间戳
}
```

### 服务端表结构

1. **user_credits** - 用户总次数记录
2. **usage_logs** - 每次使用记录（审计）
3. **activation_codes** - 激活码（管理员生成）
4. **activation_usage** - 激活码使用记录
5. **invite_codes** - 邀请码（用户生成）
6. **invite_usage** - 邀请码使用记录

## API 设计

### 用户 API

1. **GET /api/credits** - 获取剩余次数
2. **POST /api/activate** - 使用激活码充值
3. **POST /api/invite/generate** - 生成邀请码
4. **POST /api/invite/use** - 使用邀请码
5. **POST /api/gemini** - 使用服务（会自动扣除次数）

### 管理 API

1. **POST /admin/generate** - 生成激活码（100次）
2. **GET /admin/stats** - 统计信息
   - 激活码使用情况
   - 邀请码使用情况
   - 用户使用统计

## 关键逻辑

### 免费试用
- 首次使用：检查 `free_trials_used < 3`
- 如果未满3次：允许使用，不扣除 credits，只增加 `free_trials_used`
- 如果已满3次：检查 `remaining_credits > 0`

### 激活码使用
- 验证激活码存在且状态为 active
- 增加用户 credits：+100
- 记录激活使用历史

### 邀请码使用
- 验证邀请码存在且未被使用
- 验证邀请者 ≠ 被邀请者（设备指纹不同）
- 验证被邀请者未使用过其他邀请码
- 双方各增加 3 次 credits
- 标记邀请码为已使用

### 防篡改机制
- 每次使用时，服务端验证：
  - 客户端传入的剩余次数是否与服务端一致（允许小误差）
  - 如果不一致，以服务端为准
  - 扣除次数后返回新的剩余次数

## 改进点总结

✅ **支持次数叠加**：可以多次激活累积次数  
✅ **防篡改验证**：服务端记录真实数据  
✅ **免费试用**：前3次无需激活码  
✅ **邀请系统**：用户可生成邀请码  
✅ **防刷机制**：防止自邀请、重复使用  
✅ **完整审计**：所有操作都有记录

